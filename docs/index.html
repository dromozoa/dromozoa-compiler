<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>dromozoa-compiler</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/3.0.1/github-markdown.min.css">
<style>
.markdown-body {
  box-sizing: border-box;
  min-width: 200px;
  max-width: 980px;
  margin: 0 auto;
  padding: 45px;
}
@media (max-width: 767px) {
  .markdown-body {
    padding: 15px;
  }
}
table.ir tr td:first-child {
  white-space: nowrap;
}
</style>
</head>
<body>
<div class="markdown-body">

<h1>dromozoa-compiler</h1>

<h2>ドキュメント</h2>

<ul>
  <li><a href="camera.html">カメラの移動とズーム</a></li>
</ul>

<h2>文字列から数値型への変換</h2>

<p>
整数への変換を試行してから浮動小数点数への変換を試行する。
</p>

<p>
整数への変換は前後のホワイトスペースを無視したうえで、整数の字句表現に従う。
8進数リテラルがないので、リテラル<code>070</code>は10進数の整数<code>70</code>に等しい。
また、リテラル<code>34e1</code>は16進数の整数<code>0x34e1 = 520</code>はなく、
浮動小数点数<code>34.0e1 = 340</code>に等しいことに注意する。
</p>

<pre>
10進数整数リテラル: [+\-]?[0-9]+
16進数整数リテラル: [+\-]?0[xX][0-9A-Fa-f]+
</pre>

<p>
浮動小数点数への変換は<code>strtod</code>と等価である。
</p>

<h2>Variables</h2>

<table>
  <tr>
    <th>Code</th>
    <th>Type</th>
    <th>Mode</th>
    <th>Description</th>
  </tr>
  <tr>
    <td><code>n</code></td>
    <td>immediate</td>
    <td>read only</td>
    <td>unsigned integer</td>
  <tr>
  <tr>
    <td><code>NIL</code></td>
    <td>immediate</td>
    <td>read only</td>
    <td>nil</td>
  </tr>
  <tr>
    <td><code>FALSE</code></td>
    <td>immediate</td>
    <td>read only</td>
    <td>false</td>
  </tr>
  <tr>
    <td><code>TRUE</code></td>
    <td>immediate</td>
    <td>read only</td>
    <td>true</td>
  </tr>
  <tr>
    <td><code>Pn</code></td>
    <td>proto</td>
    <td>read only</td>
    <td></td>
  </tr>
  <tr>
    <td><code>Ln</code></td>
    <td>label</td>
    <td>read only</td>
    <td>named label</td>
  </tr>
  <tr>
    <td><code>Mn</code></td>
    <td>label</td>
    <td>read only</td>
    <td>unnamed label</td>
  </tr>
  <tr>
    <td><code>Kn</code></td>
    <td>constant</td>
    <td>read only</td>
    <td></td>
  </tr>
  <tr>
    <td><code>Un</code></td>
    <td>value</td>
    <td>reference</td>
    <td>upvalue</td>
  </tr>
  <tr>
    <td><code>An</code>, <code>An_v</code></td>
    <td>value</td>
    <td>reference?</td>
    <td>parameter</td>
  </tr>
  <tr>
    <td><code>Bn</code>, <code>Bn_v</code></td>
    <td>value</td>
    <td>reference?</td>
    <td>named value</td>
  </tr>
  <tr>
    <td><code>Cn</code></td>
    <td>value</td>
    <td>single assigned</td>
    <td>unnamed value</td>
  </tr>
  <tr>
    <td><code>V0</code>, <code>V0[i]</code></td>
    <td>array</td>
    <td>read only</td>
    <td>vararg</td>
  </tr>
  <tr>
    <td><code>Tn</code></td>
    <td>array</td>
    <td>single assigned</td>
    <td>results</td>
  </tr>
</table>

<h2>IR</h2>

<p>
<code>CALL</code>と<code>TYPENAME</code>以外はメタフィールドを考慮しない。
</p>

<table class="ir">
  <tr>
    <th>Opcode</th>
    <th>Code</th>
    <th>Description</th>
  </tr>

  <tr>
    <td><code>MOVE A B</code></td>
    <td><code>A = B</code></td>
    <td></td>
  </tr>

  <tr>
    <td><code>GETTABLE A B C</code></td>
    <td><code>A = B[C]</code></td>
    <td></td>
  </tr>

  <tr>
    <td><code>NEWTABLE A</code></td>
    <td><code>A = {}</code></td>
    <td></td>
  </tr>

  <tr>
    <td><code>SETTABLE A B C</code></td>
    <td><code>A[B] = C</code></td>
    <td><code>C</code>が配列の場合、<code>B</code>は必ず即値整数で、<code>C</code>は展開される。</td>
  </tr>

  <tr>
    <td><code>binop A B C</code></td>
    <td><code>A = B binop C</code></td>
    <td></td>
  </tr>

  <tr>
    <td><code>unop A B</code></td>
    <td><code>A = unop B</code></td>
    <td></td>
  </tr>

  <tr>
    <td>
      <code>CALL A B...</code><br>
      <code>RESULT C...</code>
    </td>
    <td><code>C... = A(B...)</code></td>
    <td>可変長の返り値を扱う場合、<code>C...</code>は配列が1個指定される。</td>
  </tr>

  <tr>
    <td><code>RETURN A...</code></td>
    <td><code>return A...</code></td>
    <td></td>
  </tr>

  <tr>
    <td><code>CLOSURE A B C...</code></td>
    <td><code>A = closure(B, C...)</code></td>
    <td><code>C</code>は外部変数/参照。</td>
  </tr>

  <tr>
    <td><code>LABEL A</code></td>
    <td><code>::A::</code></td>
    <td>基本ブロック変換で除去。</td>
  </tr>

  <tr>
    <td><code>BREAK</code></td>
    <td><code>break</code></td>
    <td>ループ変換で<code>GOTO</code>に置換。</td>
  </tr>

  <tr>
    <td><code>GOTO A</code></td>
    <td><code>goto A</code></td>
    <td>基本ブロック変換で除去。</td>
  </tr>

  <tr>
    <td><code>COND A B C</code></td>
    <td><code>if toboolean(A) then goto B else goto C end</code></td>
    <td>基本ブロック変換後は<code>B</code>,<code>C</code>ではなくエッジを参照。</td>
  </tr>

  <tr>
    <td><code>TYPE A B</code></td>
    <td><code>A = lua_type(B)</code></td>
    <td>型を整数で取得する。返される値は<a href="#basic-types">Lua 5.3 basic types</a>を参照。</td>
  </tr>

  <tr>
    <td><code>TYPENAME A B</code></td>
    <td><code>A = type(B)</code></td>
    <td>型の名前を取得する。<code>__name</code>メタフィールドを考慮する。</td>
  </tr>

  <tr>
    <td><code>TONUMBER A B</code></td>
    <td><code>A = tonumber(B)</code></td>
    <td>数値か数値に変換可能な文字列でなければ<code>nil</code>を返す。</td>
  </tr>

  <tr>
    <td><code>TOINTEGER A B</code></td>
    <td><code>A = tointeger(B)</code></td>
    <td>整数か整数に変換可能な文字列でなければ<code>nil</code>を返す。</td>
  </tr>

  <tr>
    <td><code>TOSTRING A B</code></td>
    <td><code>A = tostring(B)</code></td>
    <td>数値か文字列でなければ<code>nil</code>を返す。</td>
  </tr>

  <tr>
    <td><code>ERROR A B</code></td>
    <td><code>error(A, B)</code></td>
    <td>エラーを送出する。Bは必ず即値整数である。</td>
  </tr>

  <tr>
    <td><code>GETMETAFIELD A B C</code></td>
    <td><code>A = getmetafield(B, C)</code></td>
    <td><code>B</code>のメタテーブルが存在し、イベント<code>C</code>のフィールドがあるかを検査する。</td>
  </tr>
</table>

<h3>and</h3>

<pre>
a = b and c
</pre>

<pre>
if b then
  a = c
else
  a = b
end
</pre>

<pre>
COND_IF b
  MOVE a c
COND_ELSE
  MOVE a b
COND_END
</pre>

<h3>or</h3>

<pre>
a = b or c
</pre>

<pre>
if b then
  a = b
else
  a = c
end
</pre>

<pre>
COND_IF b
  MOVE a b
COND_ELSE
  MOVE a c
END
</pre>

<h3>numerical for without step</h3>

<pre>
for u3 = u1, u2 do
  ...
end
</pre>

<pre>
B v1 var (initial value)
C v2 limit
C v3
K v4 "'for' initial value must be a number"
K v5 "'for' limit must be a number"
</pre>

<pre>
TONUMBER v1 u1
TONUMBER v2 u2

COND_IF v2
  ;
COND_ELSE
  ERROR v5 0
COND_END

COND_IF v1
  ;
COND_ELSE
  ERROR v4 0
COND_END

SUB v1 v1 1
LOOP
  ADD v1 v1 1

  LT v3 v2 v1
  COND_IF v3
    BREAK
  COND_END

  MOVE u3 v1
  ...
LOOP_END
</pre>

<h3>numerical for with step</h3>

<pre>
for u4 = u1, u2, u3 do
  ...
end
</pre>

<pre>
B v1 var (initial value)
C v2 limit
C v3 step
C v4
C v5
C v6
C v7
K v8 "'for' initial value must be a number"
K v9 "'for' limit must be a number"
K v10 "'for' step must be a number"
</pre>

<pre>
TONUMBER v1 u1
TONUMBER v2 u2
TONUMBER v3 u3

COND_IF v3
  ;
COND_ELSE
  ERROR v10 0
COND_END

COND_IF v2
  ;
COND_ELSE
  ERROR v9 0
COND_END

COND_IF v1
  ;
COND_ELSE
  ERROR v8 0
COND_END

SUB v1 v1 v3
LOOP
  ADD v1 v1 v3

  LE v4 0 v3
  COND_IF v4
    LT v5 v2 v1
    COND_IF v5
      BREAK
    COND_END
  COND_END

  LT v6 v3 0
  COND_IF v6
    LT v7 v1 v2
    COND_IF v7
      BREAK
    COND_END
  COND_END

  MOVE u4 v1
  ...
LOOP_END
</pre>

<h2>metatable</h2>

<table>
  <tr><th>Event    </th><th>Mode </th><th>Behavior</th><th>Description</th></tr>
  <tr><td>add      </td><td>binop</td><td>arithmetic </td><td><code>+</code></td></tr>
  <tr><td>sub      </td><td>binop</td><td>arithmetic </td><td><code>-</code></td></tr>
  <tr><td>mul      </td><td>binop</td><td>arithmetic </td><td><code>*</code></td></tr>
  <tr><td>div      </td><td>binop</td><td>arithmetic </td><td><code>/</code></td></tr>
  <tr><td>mod      </td><td>binop</td><td>arithmetic </td><td><code>%</code></td></tr>
  <tr><td>pow      </td><td>binop</td><td>arithmetic </td><td><code>^</code></td></tr>
  <tr><td>unm      </td><td>unop </td><td>arithmetic </td><td><code>-</code></td></tr>
  <tr><td>idiv     </td><td>binop</td><td>arithmetic </td><td><code>//</code></td></tr>
  <tr><td>band     </td><td>binop</td><td>bitwise    </td><td><code>&amp;</code></td></tr>
  <tr><td>bor      </td><td>binop</td><td>bitwise    </td><td><code>|</code></td></tr>
  <tr><td>bxor     </td><td>binop</td><td>bitwise    </td><td><code>~</code></td></tr>
  <tr><td>bnot     </td><td>unop </td><td>bitwise    </td><td><code>~</code></td></tr>
  <tr><td>shl      </td><td>binop</td><td>bitwise    </td><td><code>&lt;&lt;</code></td></tr>
  <tr><td>shr      </td><td>binop</td><td>bitwise    </td><td><code>&gt;&gt;</code></td></tr>
  <tr><td>concat   </td><td>binop</td><td>concatenate</td><td><code>..</code></td></tr>
  <tr><td>len      </td><td>unop </td><td>length     </td><td><code>#</code></td></tr>
  <tr><td>eq       </td><td>binop</td><td>           </td><td><code>==</code></td></tr>
  <tr><td>lt       </td><td>binop</td><td>           </td><td><code>&lt;</code></td></tr>
  <tr><td>le       </td><td>binop</td><td>           </td><td><code>&lt;=</code></td></tr>
  <tr><td>index    </td><td>     </td><td>           </td><td></td></tr>
  <tr><td>newindex </td><td>     </td><td>           </td><td></td></tr>
  <tr><td>call     </td><td>     </td><td>           </td><td></td></tr>
  <tr><td>gc       </td><td>     </td><td>           </td><td>garbage colleciton</td></tr>
  <tr><td>mode     </td><td>     </td><td>           </td><td>weak table</td></tr>
  <tr><td>name     </td><td>     </td><td>           </td><td><code>luaL_newmetatable</code></td></tr>
  <tr><td>tostring </td><td>     </td><td>           </td><td><code>tostring</code></td></tr>
  <tr><td>metatable</td><td>     </td><td>           </td><td>protected metatable</td></tr>
  <tr><td>pairs    </td><td>     </td><td>           </td><td><code>pairs</code></td></tr>
</table>

<h3>arithmetic/bitwise/concatenate binop</h3>

<pre>
u = u1 {binop} u2
</pre>

<pre>
if "{opname}" == "arithmetic" then
  message = "attempt to perform arithmetic operation on a "
  convert = TONUMBER
elseif "{opname}" == "bitwise" then
  message = "attempt to perform bitwise operation on a "
  convert = TOINTEGER
elseif "{opname}" == "concatenate" then
  message = "attempt to perform concatenate on a "
  convert = TOSTRING
end
</pre>

<pre>
B v1
B v2
B v3
B v4
C v5
C v6
C v7
C v8
K v9 "__{binop:lower()}"
K v10 "{message}"
K v11 " value"
</pre>

<pre>
{convert} v5 u1
{convert} v6 u2

COND_IF v5
  MOVE v1 v6
COND_ELSE
  MOVE v1 v5
COND_END

COND_IF v1
  {binop} v2 v5 v6
COND_ELSE
  GETMETAFILED v3 u1 v9
  COND_IF v3
    ;
  COND_ELSE
    GETMETAFILED v3 u2 v9
  COND_END

  COND_IF v3
    CALL v3 u1 u2
    RESULT v2
  COND_ELSE
    COND_IF v5
      TYPENAME v4 u2
    COND_ELSE
      TYPENAME v4 u1
    COND_END
    CONCAT v7 v10 v4
    CONCAT v8 v7 v11
    ERROR v8 0
  COND_END
COND_END

MOVE u v2
</pre>

<h3>arithmetic/bitwise unop</h3>

<pre>
u = {unop} u1
</pre>

<pre>
if "{opname}" == "arithmetic" then
  message = "attempt to perform arithmetic operation on a "
  convert = TONUMBER
elseif "{opname}" == "bitwise" then
  message = "attempt to perform bitwise operation on a "
  convert = TOINTEGER
end
</pre>

<pre>
B v1
C v2
C v3
C v4
C v5
C v6
K v7 "__{unop:lower()}"
K v8 "{message}"
K v9 " value"
</pre>

<pre>
{convert} v2 u1

COND_IF v2
  {unop} v1 v2
COND_ELSE
  GETMETAFILED v3 u1 v7

  COND_IF v3
    CALL v3 u1
    RESULT v1
  COND_ELSE
    TYPENAME v4 u1
    CONCAT v5 v8 v4
    CONCAT v6 v5 v9
    ERROR v6 0
  COND_END
COND_END

MOVE u v1
</pre>

<h2 id="basic-types">Lua 5.3 basic types</h2>

<pre>
#define LUA_TNIL		0
#define LUA_TBOOLEAN		1
#define LUA_TLIGHTUSERDATA	2
#define LUA_TNUMBER		3
#define LUA_TSTRING		4
#define LUA_TTABLE		5
#define LUA_TFUNCTION		6
#define LUA_TUSERDATA		7
#define LUA_TTHREAD		8
</pre>

</div>
</body>
</html>
