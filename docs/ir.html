<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>dromozoa-compiler</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/3.0.1/github-markdown.min.css">
<style>
.markdown-body {
  box-sizing: border-box;
  min-width: 200px;
  max-width: 980px;
  margin: 0 auto;
  padding: 45px;
}
@media (max-width: 767px) {
  .markdown-body {
    padding: 15px;
  }
}
table.ir tr td:first-child {
  white-space: nowrap;
}
</style>
</head>
<body>
<div class="markdown-body">

<h1>dromozoa-compiler</h1>

<h2>IR</h2>

<p>
<code>CALL</code>と<code>TYPENAME</code>以外はメタフィールドを考慮しない。
</p>

<table class="ir">
  <tr>
    <th>Opcode</th>
    <th>Code</th>
    <th>Description</th>
  </tr>

  <tr>
    <td><code>MOVE A B</code></td>
    <td><code>A = B</code></td>
    <td></td>
  </tr>

  <tr>
    <td><code>GETTABLE A B C</code></td>
    <td><code>A = B[C]</code></td>
    <td></td>
  </tr>

  <tr>
    <td><code>NEWTABLE A</code></td>
    <td><code>A = {}</code></td>
    <td></td>
  </tr>

  <tr>
    <td><code>SETTABLE A B C</code></td>
    <td><code>A[B] = C</code></td>
    <td><code>C</code>が配列の場合、<code>B</code>は必ず即値整数で、<code>C</code>は展開される。</td>
  </tr>

  <tr>
    <td><code>binop A B C</code></td>
    <td><code>A = B binop C</code></td>
    <td></td>
  </tr>

  <tr>
    <td><code>unop A B</code></td>
    <td><code>A = unop B</code></td>
    <td></td>
  </tr>

  <tr>
    <td>
      <code>CALL A B...</code><br>
      <code>RESULT C...</code>
    </td>
    <td><code>C... = A(B...)</code></td>
    <td>可変長の返り値を扱う場合、<code>C...</code>は配列が1個指定される。<code>__call</code>メタフィールドを考慮する。</td>
  </tr>

  <tr>
    <td><code>RETURN A...</code></td>
    <td><code>return A...</code></td>
    <td></td>
  </tr>

  <tr>
    <td><code>CLOSURE A B C...</code></td>
    <td><code>A = closure(B, C...)</code></td>
    <td><code>C</code>は外部変数/参照。</td>
  </tr>

  <tr>
    <td><code>LABEL A</code></td>
    <td><code>::A::</code></td>
    <td>基本ブロック変換で除去。</td>
  </tr>

  <tr>
    <td><code>BREAK</code></td>
    <td><code>break</code></td>
    <td>ループ変換で<code>GOTO</code>に置換。</td>
  </tr>

  <tr>
    <td><code>GOTO A</code></td>
    <td><code>goto A</code></td>
    <td>基本ブロック変換で除去。</td>
  </tr>

  <tr>
    <td><code>COND A B C</code></td>
    <td><code>if toboolean(A) then goto B else goto C end</code></td>
    <td>基本ブロック変換後は<code>B</code>,<code>C</code>ではなくエッジを参照。</td>
  </tr>

  <tr>
    <td><code>TYPE A B</code></td>
    <td><code>A = lua_type(B)</code></td>
    <td>型を整数で取得する。返される値は<a href="#basic-types">Lua 5.3 basic types</a>を参照。</td>
  </tr>

  <tr>
    <td><code>TYPENAME A B</code></td>
    <td><code>A = type(B)</code></td>
    <td>型の名前を取得する。<code>__name</code>メタフィールドを考慮する。</td>
  </tr>

  <tr>
    <td><code>TONUMBER A B</code></td>
    <td><code>A = tonumber(B)</code></td>
    <td>数値か数値に変換可能な文字列でなければ<code>nil</code>を返す。</td>
  </tr>

  <tr>
    <td><code>TOINTEGER A B</code></td>
    <td><code>A = tointeger(B)</code></td>
    <td>整数か整数に変換可能な文字列でなければ<code>nil</code>を返す。</td>
  </tr>

  <tr>
    <td><code>TOSTRING A B</code></td>
    <td><code>A = tostring(B)</code></td>
    <td>数値か文字列でなければ<code>nil</code>を返す。</td>
  </tr>

  <tr>
    <td><code>ERROR A B</code></td>
    <td><code>error(A, B)</code></td>
    <td>エラーを送出する。Bは必ず即値整数である。</td>
  </tr>

  <tr>
    <td><code>GETMETAFIELD A B C</code></td>
    <td><code>A = getmetafield(B, C)</code></td>
    <td><code>B</code>のメタテーブルが存在し、イベント<code>C</code>のフィールドがあるかを検査する。</td>
  </tr>
</table>

<h3>and</h3>

<pre>
a = b and c
</pre>

<pre>
if b then
  a = c
else
  a = b
end
</pre>

<pre>
COND_IF b
  MOVE a c
COND_ELSE
  MOVE a b
COND_END
</pre>

<h3>or</h3>

<pre>
a = b or c
</pre>

<pre>
if b then
  a = b
else
  a = c
end
</pre>

<pre>
COND_IF b
  MOVE a b
COND_ELSE
  MOVE a c
END
</pre>

<h3>numerical for without step</h3>

<pre>
for u3 = u1, u2 do
  ...
end
</pre>

<pre>
B v1 var (initial value)
C v2 limit
C v3
K v4 "'for' initial value must be a number"
K v5 "'for' limit must be a number"
</pre>

<pre>
TONUMBER v1 u1
TONUMBER v2 u2

COND_IF v2
  ;
COND_ELSE
  ERROR v5 0
COND_END

COND_IF v1
  ;
COND_ELSE
  ERROR v4 0
COND_END

SUB v1 v1 1
LOOP
  ADD v1 v1 1

  LT v3 v2 v1
  COND_IF v3
    BREAK
  COND_END

  MOVE u3 v1
  ...
LOOP_END
</pre>

<h3>numerical for with step</h3>

<pre>
for u4 = u1, u2, u3 do
  ...
end
</pre>

<pre>
B v1 var (initial value)
C v2 limit
C v3 step
C v4
C v5
C v6
C v7
K v8 "'for' initial value must be a number"
K v9 "'for' limit must be a number"
K v10 "'for' step must be a number"
</pre>

<pre>
TONUMBER v1 u1
TONUMBER v2 u2
TONUMBER v3 u3

COND_IF v3
  ;
COND_ELSE
  ERROR v10 0
COND_END

COND_IF v2
  ;
COND_ELSE
  ERROR v9 0
COND_END

COND_IF v1
  ;
COND_ELSE
  ERROR v8 0
COND_END

SUB v1 v1 v3
LOOP
  ADD v1 v1 v3

  LE v4 0 v3
  COND_IF v4
    LT v5 v2 v1
    COND_IF v5
      BREAK
    COND_END
  COND_END

  LT v6 v3 0
  COND_IF v6
    LT v7 v1 v2
    COND_IF v7
      BREAK
    COND_END
  COND_END

  MOVE u4 v1
  ...
LOOP_END
</pre>

</div>
</body>
</html>
